C51 COMPILER V7.06   PWM                                                                   07/25/2013 23:19:41 PAGE 1   


C51 COMPILER V7.06, COMPILATION OF MODULE PWM
OBJECT MODULE PLACED IN pwm.OBJ
COMPILER INVOKED BY: C:\software\keil\C51\BIN\C51.EXE pwm.c COMPACT BROWSE DEBUG OBJECTEXTEND

stmt level    source

   1          
   2          #include "config.h"
   3          
   4          //标准频率
   5          unsigned int code frqB[3]={100,977,7813};
   6          //DDS步进值  Step=f*2^16/62500
   7          unsigned int code Step[3]={105,1049,8193};
   8          //查询表中不可装载零值，否则会造成无中断产生
   9          unsigned char code sinB[256]={
  10           255,255,255,255,255,255,254,254,253,252,252,251,250,249,248,247,246,245,243,242,240,239,237,236,234,232,2
             -30,229,227,225,222,220,
  11           218,216,214,211,209,206,204,201,199,196,194,191,188,185,183,180,177,174,171,168,165,162,159,156,153,150,1
             -47,144,140,137,134,131,
  12           128,125,122,119,116,112,109,106,103,100, 97, 94, 91, 88, 85, 82, 79, 76, 73, 71, 68, 65, 62, 60, 57, 55, 
             -52, 50, 47, 45, 42, 40,
  13            38, 36, 34, 31, 29, 27, 26, 24, 22, 20, 19, 17, 16, 14, 13, 11, 10,  9,  8,  7,  6,  5,  4,  4,  3,  2, 
             - 2,  1,  1,  1,  1,  1,
  14             1,  1,  1,  1,  1,  1,  2,  2,  3,  4,  4,  5,  6,  7,  8,  9, 10, 11, 13, 14, 16, 17, 19, 20, 22, 24, 
             -26, 27, 29, 31, 34, 36,
  15            38, 40, 42, 45, 47, 50, 52, 55, 57, 60, 62, 65, 68, 71, 73, 76, 79, 82, 85, 88, 91, 94, 97,100,103,106,1
             -09,112,116,119,122,125,
  16           128,131,134,137,140,144,147,150,153,156,159,162,165,168,171,174,177,180,183,185,188,191,194,196,199,201,2
             -04,206,209,211,214,216,
  17           218,220,222,225,227,229,230,232,234,236,237,239,240,242,243,245,246,247,248,249,250,251,252,252,253,254,2
             -54,255,255,255,255,255
  18          };
  19          
  20          unsigned char code fbB[256]={ //方波DDS查询表
  21          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
             -0,0,0,0,0,0,0,0,0,0,0,
  22          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
             -0,0,0,0,0,0,0,0,0,0,0,
  23          1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
             -1,1,1,1,1,1,1,1,1,1,1,
  24          1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
             -1,1,1,1,1,1,1,1,1,1,1};
  25          
  26          //相位,0度 90度 180度 270度
  27          code unsigned char angleB[4] = {0,64,128,192};
  28          
  29          extern  Frq_idx;
  30          extern  Vxy_idx;
  31          unsigned int Sin_Phase=0;     //正弦相位累加值
  32          xdata float Actual_Frq=976.6; //实际输出频率
  33          
  34          
  35          xdata unsigned char xw=0; //相位
  36          xdata unsigned char tim=0,tims=0;
  37          int DDS3=1;
  38          unsigned char mT = 6; //测量速度,mT取值为6或12或24时，可以消除数字噪声，尾数不动，但不利于于取平均
  39          
  40          
  41          /***********************************************************************
  42          Function : PWM_Init 
  43          Note     : PWM初始化
C51 COMPILER V7.06   PWM                                                                   07/25/2013 23:19:41 PAGE 2   

  44          ***********************************************************************/
  45          void PWM_init (void)
  46          {  
  47   1        CMOD = 2;        //0000 0010 计数源选择,钟源取fosc/2
  48   1        CL = 0; CH = 0;  //计数器置零
  49   1        CCAP0L = 0xC0; CCAP0H = 0xC0; //占空比为25%
  50   1        CCPAM0=0x53;  //0101 0011,PCA的模块0设置为PWM模式,有中断，下降沿中断
  51   1        PPCA = 1;     //优先中断
  52   1        CR = 1;   //开始计数
  53   1      }  
  54          
  55          /***********************************************************************
  56          Function : PCAinter interrupt
  57          Note     : PCA中断处理函数
  58          ***********************************************************************/
  59          void PCAinter(void) interrupt 7 
  60          {
  61   1        unsigned char x,y;
  62   1        CCF0=0;          //清除中断请求,以免反复中断
  63   1        x = Sin_Phase << 8 ;        //截断正弦相位累加器,取高8位
  64   1        y = x + angleB[Vxy_idx];    //方波相位
  65   1        CCAP0H = sinB[x]; //正弦DDS输出
  66   1        KFB = fbB[y];     //方波DDS输
  67   1        Sin_Phase += Step[Frq_idx];       //相位累加
  68   1        K32 = ~K32;
  69   1      }
  70          
  71          /***********************************************************************
  72          Function : setDDS
  73          Note     : 低频信号DDS函数
  74                     参考时钟是c=(fosc/2)/256=32000000/2/256=62500,频率f=c*Step/2^16
  75          ***********************************************************************/
  76          void setDDS(unsigned char frqIndex)
  77          { 
  78   1       //Actual_Frq = frqB[frqIndex]*(1+cs.feq/10000.0);  //实际输出频率 加修正值
  79   1       Actual_Frq = frqB[frqIndex];
  80   1       Sin_Phase = 0;                                     //高频时，使波形对称
  81   1      }    
  82          
  83          
  84          
  85          
  86           
  87          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    159    ----
   CONSTANT SIZE    =    528    ----
   XDATA SIZE       =      7    ----
   PDATA SIZE       =      5    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
